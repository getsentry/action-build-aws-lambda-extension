name: "Build AWS Lambda Extension"
description: "Creates a packaged Lambda layer including the Sentry Lambda extension."
inputs:
  artifact_name:
    description: Name of the prepared articact to package into an Lambda extension
    required: true
  zip_file_name:
    description: Name of the zip file that will be created
    required: true
runs:
  using: "composite"
  steps:
    - uses: actions/download-artifact@v3
      with:
        name: ${{ inputs.artifact_name }}
    - name: Create directory
      shell: bash
      run: |
        echo "in action:"
        ls -alh dist-serverless
        mkdir -p dist-serverless/extensions
        curl -0 --silent --output dist-serverless/extensions/sentry-lambda-extension `curl -s https://release-registry.services.sentry.io/apps/sentry-lambda-extension/latest | jq -r .files.\"sentry-lambda-extension\".url`
        chmod +x dist-serverless/extensions/sentry-lambda-extension
    - name: Zip directory
      shell: bash
      run: |
        zip -r ${{ inputs.zip_file_name }} dist-serverless/ -x \*__pycache__\* -x \*.yml
        echo "Contents of the created ZIP file:"
        unzip -Z1 ${{ inputs.zip_file_name }}
    - name: Upload zip
      uses: actions/upload-artifact@v3
      with:
        name: ${{ inputs.artifact_name }}
        path: ${{ inputs.zip_file_name }}
